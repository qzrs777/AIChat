name: Build and Package AIChat Mod

on:
  workflow_dispatch:
  schedule:
    # 每日北京时间 11:00 (即 UTC 时间 03:00) 触发
    - cron: '0 3 * * *'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout AIChat
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y mono-complete zip

      - name: Build AIChat.dll
        run: |
          make GAME_ROOT="${{ github.workspace }}/build-resource/buildenv/mokgamedir"

      - name: Copy AIChat.dll to assets
        run: |
          cp AIChat/bin/Release/AIChat.dll build-resource/assets/

      - name: Zip Artifact
        run: |
          cd build-resource/assets/
          zip -r ../../AIChatMod.zip .

      - name: Get commit info
        id: info
        run: |
          echo "hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          #echo "hash_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "time=$(git log -1 --date=format-local:'%Y-%m-%d %H:%M:%S UTC' --format='%cd')" >> $GITHUB_OUTPUT
        env:
          TZ: UTC

      - name: Update Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: preview
          name: "Preview Build"
          body: |
            [![Build Status](https://github.com/qzrs777/AIChat/actions/workflows/build.yml/badge.svg)](https://github.com/qzrs777/AIChat/actions/workflows/build.yml)
            此为无固定版本号的预览版本，每日自动构建，也可由维护者手动触发。

            此构建的 Commit 信息：
            - HASH: ${{ steps.info.outputs.hash }}
            - 时间: ${{ steps.info.outputs.time }}
          prerelease: true
          files: AIChatMod.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
